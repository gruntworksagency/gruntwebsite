---
import MainLayout from "@/layouts/MainLayout.astro";
import { auth } from "../lib/auth";

export const prerender = false;

const session = await auth.api.getSession({
  headers: Astro.request.headers,
});

const pageTitle: string = "Audit Contact Request";
const metaDescription: string = "Submit your information for an audit request.";
---

<MainLayout title={pageTitle} customDescription={metaDescription}>
  <section class="mx-auto bg-neutral-200 px-4 pt-[150px] pb-10">
    <div class="mx-auto max-w-2xl">
      <div class="text-center">
        <h1 class="text-2xl font-bold text-neutral-800 md:text-4xl">
          Audit Contact Request
        </h1>
        <p class="mt-1 text-neutral-600">
          {
            session?.user?.name
              ? `Welcome back, ${session.user.name}! Please fill out the form below.`
              : "Please fill out the form below with your information."
          }
        </p>
      </div>

      {
        session?.user && (
          <div class="mt-4 text-center">
            <p class="text-sm text-neutral-600">
              Signed in as: {session.user.email}
            </p>
            <button
              id="signout-btn"
              class="mt-2 text-sm text-blue-600 hover:underline"
            >
              Sign Out
            </button>
          </div>
        )
      }

      <div class="mt-12 flex flex-col rounded-xl p-4">
        <h2 class="mb-8 text-xl font-bold text-neutral-700">
          Your Information
        </h2>
        <form method="POST">
          <div class="grid gap-4">
            <input
              type="text"
              placeholder="First Name"
              value={session?.user?.name?.split(" ")[0] || ""}
              required
            />
            <input
              type="text"
              placeholder="Last Name"
              value={session?.user?.name?.split(" ")[1] || ""}
              required
            />
            <input
              type="email"
              placeholder="Email"
              value={session?.user?.email || ""}
              required
            />
            <input type="tel" placeholder="Phone" />
            <textarea placeholder="Message" required></textarea>
          </div>
          <button
            type="submit"
            class="mt-4 rounded bg-blue-600 px-4 py-2 text-white"
          >
            Submit Request
          </button>
        </form>
      </div>
    </div>
  </section>
</MainLayout>

<script>
  import { authClient } from "../lib/auth-client";

  const signoutButton = document.getElementById("signout-btn");
  if (signoutButton) {
    signoutButton.addEventListener("click", async () => {
      try {
        await authClient.signOut();
        window.location.href = "/login";
      } catch (error) {
        console.error("Sign out error:", error);
      }
    });
  }
</script>
